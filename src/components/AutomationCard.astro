---
import type { Automation } from '../utils/data';
import { loadTags } from '../utils/data';

interface Props {
  automation: Automation;
}

const { automation } = Astro.props;

// Load tags to get colors
const allTags = loadTags();
// Normalize tag names: lowercase and replace hyphens with spaces for matching
const normalizeTagName = (name: string) => name.toLowerCase().replace(/-/g, ' ');
const tagColorMap = new Map(allTags.map(t => [normalizeTagName(t.name), t.color]));

// Helper to convert hex to RGB for transparency
const hexToRgb = (hex: string) => {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : null;
};

// Helper to get contrasting text color (unused but kept for future use)
// const getTextColor = (bgColor: string) => {
//   const rgb = hexToRgb(bgColor);
//   if (!rgb) return '#ffffff';
//   const brightness = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000;
//   return brightness > 128 ? '#000000' : '#ffffff';
// };

const formatDate = (dateStr: string) => {
  return new Date(dateStr).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
};

const formatCurrency = (amount: number) => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(amount);
};

const getStatusBadgeClass = (status: string) => {
  switch (status) {
    case 'live':
      return 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300';
    case 'development':
      return 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300';
    case 'backlog':
      return 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300';
    default:
      return 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300';
  }
};

const getStatusLabel = (status: string) => {
  switch (status) {
    case 'live':
      return 'Live';
    case 'development':
      return 'Dev';
    case 'backlog':
      return 'Backlog';
    default:
      return status;
  }
};
---

<a href={`/automations/${automation.id}`} class="card block p-6 hover:scale-[1.02] transition-transform">
  <div class="flex justify-between items-start mb-3">
    <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100">{automation.name}</h3>
    <div class="flex gap-2">
      <span class={`badge ${getStatusBadgeClass(automation.status)}`}>
        {getStatusLabel(automation.status)}
      </span>
      <span class="badge bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300">
        {automation.department}
      </span>
    </div>
  </div>

  <p class="text-gray-600 dark:text-gray-400 text-sm mb-4 line-clamp-2">
    {automation.description}
  </p>

  <div class="flex flex-wrap gap-2 mb-4">
    {automation.tags.slice(0, 3).map(tag => {
      const color = tagColorMap.get(normalizeTagName(tag));
      const rgb = color ? hexToRgb(color) : null;

      return color && rgb ? (
        <span
          class="tag-colored text-xs font-medium px-2.5 py-1 rounded border-2 transition-colors"
          style={`
            --tag-color: ${color};
            --tag-bg-light: rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.15);
            --tag-bg-dark: rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.25);
            background: var(--tag-bg-light);
            color: #000000;
            border-color: ${color};
          `}
        >
          {tag}
        </span>
      ) : (
        <span class="badge bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">
          {tag}
        </span>
      );
    })}
    {automation.tags.length > 3 && (
      <span class="badge bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-400">
        +{automation.tags.length - 3} more
      </span>
    )}
  </div>

  <div class="grid grid-cols-2 gap-4 pt-4 border-t border-gray-200 dark:border-gray-700">
    <div>
      <p class="text-xs text-gray-500 dark:text-gray-400">Time Saved/Month</p>
      <p class="text-lg font-semibold text-gray-900 dark:text-gray-100">
        {automation.time_saved_hours_per_month}h
      </p>
    </div>
    <div>
      <p class="text-xs text-gray-500 dark:text-gray-400">Annual Value</p>
      <p class="text-lg font-semibold text-green-600 dark:text-green-400">
        {formatCurrency(automation.annual_value_usd)}
      </p>
    </div>
  </div>

  <div class="mt-4 text-xs text-gray-500 dark:text-gray-400">
    Last updated: {formatDate(automation.last_updated)}
  </div>
</a>
